<!DOCTYPE html>
<html lang="en" xmlns:sec="http://www.w3.org/1999/xhtml" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8"/>
    <title>Title</title>
    <link rel="stylesheet" type="text/css" href="/css/main.css"/>
</head>
<body>
    <div sec:authorize="hasAuthority('CHANGE_PASSWORD_PRIVILEGE')">
        <div class="login-page">
            <div class="form">
                <h2 th:text="#{message.resetYourPassword}">reset</h2>
                <form id="resetForm">
                    <input id="password" name="newPassword" type="password" value="" th:placeholder="#{label.user.password}"/>
                    <input id="matchPassword" type="password" value="" th:placeholder="#{label.user.confirmPassword}"/>
                    <div id="globalError" class="registration-alert" style="display:none" th:text="#{PasswordMatches.user}">error</div>
                    <button id="btnSubmit" type="submit" th:text="#{message.updatePassword}">submit</button>
                </form>
            </div>
        </div>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script th:inline="javascript">
            serverContext = "http://localhost:8080";
            var formError = false;
            $(document).ready(function () {
               $('form').submit(function (event) {
                 savePass(event);
               });

               $(":password").keyup(function () {
                  if($("#password").val() != $("#matchPassword").val()){
                      $("#globalError").show().html(/*[[#{PasswordMatches.user}]]*/);
                  }else{
                      $("#globalError").html("").hide();
                  }
               });

               $("#resetForm").submit(function (event){
                    formError = false;
                   checkPasswordMatch();
                   checkPasswordConstraint();
                   if(formError){
                       console.log("Not ok");
                       event.preventDefault();
                   }
                   else{
                       console.log("All ok");
                   }
               });
            });

            function checkPasswordConstraint(){
                pattern = /((?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[\W]).{8,64})/;
                password = $("#password").val();
                console.log("passwrod:"+password);
                if(pattern.test(password)){
                    $("#globalError").hide();
                }
                else{
                    $("#globalError").show().html("Password too weak (minimum 8 characters, 1 uppercase, 1 number and 1 special)");
                    formError = true;
                }
            }

            function checkPasswordMatch(){
                password = $("#password").val();
                rePassword = $("#matchPassword").val();
                if(password !== rePassword){
                    formError = true;
                }
            }

            function  savePass(event){
                event.preventDefault();
                if($("#password").val() != $("#matchPassword").val()){
                    $("#globalError").show().html(/*[[#{PasswordMatches.user}]]*/);
                    return;
                }
                var formData = $('form').serialize();
                $.post(serverContext+"/user/savePassword", formData, function (data) {
                    window.location.replace(serverContext+"/login?message="+data.message);
                })
                    .fail(function (data) {
                        var errors = $.parseJSON(data.responseJSON.message);
                        $.each( errors, function( index,item ){
                            $("#globalError").show().html(item.defaultMessage);
                        });
                        errors = $.parseJSON(data.responseJSON.error);
                        $.each( errors, function( index,item ){
                            $("#globalError").show().append(item.defaultMessage+"<br/>");
                        });
                    });
            }
        </script>
    </div>
</body>
</html>